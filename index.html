<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 2. Responsive UI / Mobile Touch Support -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3-Day Secure Chat</title>
    <style>
        :root { --primary: #007bff; --bg: #f4f4f9; --txt: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        input { font-size: 16px; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; width: 100%; max-width: 300px; }
        button { font-size: 16px; padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; max-width: 300px; }
        
        /* Chat UI */
        #chat-container { display: none; flex-direction: column; height: 100%; }
        header { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 0.9rem; color: #555; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .message { max-width: 80%; padding: 10px 14px; border-radius: 18px; position: relative; word-wrap: break-word; font-size: 15px; line-height: 1.4; }
        .my-msg { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .other-msg { align-self: flex-start; background: #e9e9eb; color: black; border-bottom-left-radius: 4px; }
        
        .meta { font-size: 0.7em; margin-top: 4px; opacity: 0.7; display: flex; justify-content: space-between; gap: 10px; }
        .del-btn { cursor: pointer; text-decoration: underline; }

        /* Input Area */
        #input-area { padding: 10px; background: #fff; border-top: 1px solid #ddd; display: flex; gap: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #msg-input { flex: 1; }
    </style>
</head>
<body>

    <!-- 4.1 Login / Room Entry -->
    <div id="login-screen">
        <h2>Secure Room</h2>
        <p style="color:#666; font-size:0.9em; margin-bottom:20px;">Messages self-destruct in 3 days.</p>
        <input type="text" id="username" placeholder="Display Name (Optional)">
        <input type="password" id="password" placeholder="Enter Room Password">
        <button onclick="joinRoom()">Enter Room</button>
    </div>

    <!-- Chat Interface -->
    <div id="chat-container">
        <header id="room-header">Room: ***</header>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="Type a message..." onkeypress="handleKey(event)">
            <button onclick="sendMessage()" style="width: auto;">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myPassword = '';
        let myUser = '';

        // 5. Identity (Local Storage)
        if(localStorage.getItem('chat_user')) document.getElementById('username').value = localStorage.getItem('chat_user');

        function joinRoom() {
            const pass = document.getElementById('password').value;
            const user = document.getElementById('username').value || 'User-' + Math.floor(Math.random()*1000);
            
            if(!pass) return alert("Password is required to generate/join a room.");
            
            myPassword = pass;
            myUser = user;
            localStorage.setItem('chat_user', user);

            socket.emit('join_room', { password: pass, username: user });
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            document.getElementById('room-header').innerText = `Room Key: ${"*".repeat(pass.length)}`;
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            // 4.2 Send Message
            socket.emit('send_message', { password: myPassword, username: myUser, text: text });
            input.value = '';
        }

        function handleKey(e) {
            if(e.key === 'Enter') sendMessage();
        }

        function deleteMessage(id) {
            if(confirm('Delete for everyone?')) {
                socket.emit('delete_message', { password: myPassword, messageId: id });
            }
        }

        // --- RENDER LOGIC ---
        function renderMessages(list) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            list.forEach(msg => {
                const div = document.createElement('div');
                const isMe = msg.user === myUser;
                div.className = `message ${isMe ? 'my-msg' : 'other-msg'}`;
                
                // Timestamp formatting
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                div.innerHTML = `
                    <div style="font-weight:bold; font-size:0.8em; margin-bottom:2px;">${msg.user}</div>
                    ${msg.text}
                    <div class="meta">
                        <span>${time}</span>
                        ${isMe ? `<span class="del-btn" onclick="deleteMessage('${msg.id}')">Delete</span>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // 4.2 & 6.3 Real-time Receive & Sync
        socket.on('receive_message', (msg) => {
            // We append for smoother UI, but full sync handles ordering
            // For MVP simplicity, we re-request history or just append
            // Here we just reload history to ensure consistency
        });

        socket.on('sync_history', (history) => {
            renderMessages(history);
        });
    </script>
</body>
</html>
